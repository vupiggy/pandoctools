all:	pdf html
pdf:	mdpdf texpdf
html:	$(MDHTMLTARGETS)
mdpdf:	$(MDPDFTARGETS)
texpdf:	$(TEXPDFTARGETS)

.PHONY: all pdf html mdpdf texpdf

ifndef DOCTOOLS
  DOCTOOLS=$(HOME)/Projects/pandoctools
endif
STYLEDIR	=	$(DOCTOOLS)/styles
ifndef TEXFONTPATH
TEXFONTPATH	=	$(DOCTOOLS)/fonts
endif
TEXINPUTS	=	$${TEXINPUTS}:$(STYLEDIR)
TEXMDPREAMBLES	=	$(wildcard $(STYLEDIR)/preamble_*.tex)
TEXPREAMBLES	=	$(wildcard $(STYLEDIR)/preamble*.tex)
TEXTEMPLATE	=	$(STYLEDIR)/md2pdf_template.tex
HTMLSTYLES	=	$(wildcard $(STYLEDIR)/*.css)
HTML5TEMPLATE	=	$(STYLEDIR)/tufte.html5
HTMLCMDCSS	=	$(foreach css, $(HTMLSTYLES), --css $(css))

clean:
	@[ -d Figures ] && make -C Figures/ CLEAN DOCTOOLS=$(DOCTOOLS)
	@echo "RM pdf html"
	@rm -f *.html *.pdf *.d

distclean:
	@[ -d Figures ] && make -C Figures/ DISTCLEAN DOCTOOLS=$(DOCTOOLS)
	@echo "RM html, pdf, figures and all intermediates"
	@rm -f *.html *.pdf *.aux *.log *.out *.toc *.xwm *.d

.PHONY: clean distclean

ifeq ($(DEBUG), y)
  OUTPUT=--verbose
else
  OUTPUT=>/dev/null 2>&1
endif

### LaTeX documents

### Dependency ###
AWK=awk
input_tex=									\
        $(shell [ "$1" != "" ] && $(AWK) '/^(\\input|\\include)\{.*\}$$/	\
                {								\
                    input=gensub(/.*{(.*)}.*/, "\\1", "g");			\
                    if (index(input, ".tex") == 0) {				\
                        if (index(input, "\\") != 1) {				\
                            printf("%s.tex ", input);				\
                        }							\
                    } else {							\
                        if (index(input, "\\") != 1) {				\
                            printf("%s ", input);				\
                        }							\
                    }								\
                }' $1)

master_tex=$(TEXPDFTARGETS:.pdf=)

tex := $(call input_tex,$(master_tex))
tex += $(call input_tex,$(tex))
%.d: %.tex
	@echo "Generate depenent inputs"
	@echo "$(<:.tex=.tex.pdf) $(<:.tex=.d): $< $(tex) $(src)" >$@

include $(master_tex:.tex=.d)

#%.tex.pdf: %.tex $(TEXPARTS) $(TEXPREAMBLES)
%.tex.pdf: %.tex $(TEXPREAMBLES)
	@echo "TeXing" $< "3 times..."
	@set -e; \
	 for i in {1..3}; do echo "TeXing $$i";									\
		TEXINPUTS=$${TEXINPUTS}:$(TEXINPUTS)								\
		xelatex -halt-on-error -shell-escape -interaction=batchmode -jobname=$(@:.pdf=) 		\
		"$(EXTRATEXARGS) \input{$<}" $(OUTPUT)								\
		|| (echo "Failed...exit"; exit 1);								\
	 done

### Markdown(Pandoc) documents
FIGURESDIR=Figures
FIGURES=$(foreach fig, $(FIGURES_PDF), $(FIGURESDIR)/$(fig))
FIGURESRC=$(foreach fig, $(FIGURES_PDF), $(FIGURESDIR)/src/$(fig:.pdf=.tikz))
$(FIGURES): $(FIGURESRC)
	@make -C Figures/ ALL TEXINPUTS=$(TEXINPUTS) DEBUG=$(DEBUG) DOCTOOLS=$(DOCTOOLS)

Figures:$(FIGURESRC)
	@make -C Figures/ ALL TEXINPUTS=$(TEXINPUTS) DEBUG=$(DEBUG) DOCTOOLS=$(DOCTOOLS)

%.md.pdf: $(MDPARTS) $(TEXMDPREAMBLES) $(FIGURES)
	@printf "%-12s %s\n" "Generating" $@
	@TEXINPUTS=$(TEXINPUTS)							\
		pandoc $(EXTRAARGS)						\
		--pdf-engine=xelatex						\
		--pdf-engine-opt="-shell-escape"				\
		--from markdown+pipe_tables+table_captions			\
		$(LISTINGS)							\
		-V fontpath="$(TEXFONTPATH)/"					\
		$(RESOURCEPATH)							\
		--template=$(TEXTEMPLATE) $(MDPARTS) -o $(OUTDIR)$@ $(OUTPUT)

%.html : $(MDPARTS) $(HTMLSTYLES) $(FIGURES)
	@printf "%-12s %s\n" "Generating" $@
	@pandoc $(EXTRAARGS)							\
		--katex=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/		\
		--toc --toc-depth=1						\
		--wrap=preserve							\
		--listings							\
		--section-divs							\
		--from markdown+tex_math_single_backslash			\
		--from markdown+definition_lists				\
		--to html5  --template=$(HTML5TEMPLATE)				\
		$(HTMLCMDCSS)							\
		--metadata date="`date`"					\
		--output $@ $(MDPARTS) $(OUTPUT)

### Figures(in TikZ)
%.pdf: src/%.tikz
	@printf "%-12s %s\n" "Tikzing " $<
	@tikzfile=$<; texfile=$${tikzfile%%.tikz}.tex; tikzfile=`basename $<`;		\
	 printf "\\\documentclass[tikz, border=10pt]{standalone}\n\n"	>$${texfile};	\
	 printf "\\\usetikzlibrary{calc,quotes,angles}\n"		>>$${texfile};	\
	 printf "\\\usepackage{amsthm}\n"				>>$${texfile};	\
	 printf "\\\usepackage{tkz-euclide}\n"				>>$${texfile};	\
	 printf "\\\usetkzobj{all}\n"					>>$${texfile};	\
	 printf "%\\\usepackage[scaled]{helvet}\n"			>>$${texfile};	\
	 printf "%\\\renewcommand{\\\ttdefault}{lmtt}\n"		>>$${texfile};	\
	 printf "\\\usepackage[T1]{fontenc}\n"				>>$${texfile};	\
	 printf "\\\usepackage{xcolor}\n"				>>$${texfile};	\
	 printf "\\\begin{document}\n"					>>$${texfile};	\
	 printf "\\\input{$${tikzfile}}\n"				>>$${texfile};	\
	 printf "\\\end{document}\n\n"					>>$${texfile};	\
	 TEXINPUTS=$(TEXINPUTS):$(TEXEXTRAINPUTS)					\
	 lualatex -interaction=nonstopmode -output-directory=./ $${texfile} $(OUTPUT)

%.svg: %.pdf
	@printf "%-12s %-20s to SVG\n" "Exporting" "$^"
	@pdf2svg $< $@
